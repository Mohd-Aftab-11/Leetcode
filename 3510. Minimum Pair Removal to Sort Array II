class Solution {
    static class Pair {
        long sum;
        int index;
        Pair(long sum, int index) {
            this.sum = sum;
            this.index = index;
        }
    }
    public int minimumPairRemoval(int[] nums) {
        int n = nums.length;
        long[] arr = new long[n];
        for (int i = 0; i < n; i++) {
            arr[i] = nums[i];
        }
        TreeSet<Pair> set = new TreeSet<>(
            (a, b) -> a.sum != b.sum
                    ? Long.compare(a.sum, b.sum)
                    : Integer.compare(a.index, b.index)
        );
        int[] next = new int[n];
        int[] prev = new int[n];
        for (int i = 0; i < n; i++) {
            next[i] = i + 1;
            prev[i] = i - 1;
        }
        int badPairs = 0;
        for (int i = 0; i < n - 1; i++) {
            if (arr[i] > arr[i + 1]) badPairs++;
            set.add(new Pair(arr[i] + arr[i + 1], i));
        }
        int operations = 0;
        while (badPairs > 0) {
            Pair p = set.pollFirst();
            int left = p.index;
            int right = next[left];
            int leftNeighbor = prev[left];
            int rightNeighbor = next[right];
            if (arr[left] > arr[right]) badPairs--;
            if (leftNeighbor >= 0) {
                long oldVal = arr[left];
                long newVal = arr[left] + arr[right];
                if (arr[leftNeighbor] > oldVal && arr[leftNeighbor] <= newVal)
                    badPairs--;
                else if (arr[leftNeighbor] <= oldVal && arr[leftNeighbor] > newVal)
                    badPairs++;
            }
            if (rightNeighbor < n) {
                long oldVal = arr[right];
                long newVal = arr[left] + arr[right];
                if (arr[rightNeighbor] >= oldVal && arr[rightNeighbor] < newVal)
                    badPairs++;
                else if (arr[rightNeighbor] < oldVal && arr[rightNeighbor] >= newVal)
                    badPairs--;
            }
            if (leftNeighbor >= 0) {
                set.remove(new Pair(arr[leftNeighbor] + arr[left], leftNeighbor));
                set.add(new Pair(arr[leftNeighbor] + arr[left] + arr[right], leftNeighbor));
            }
            if (rightNeighbor < n) {
                set.remove(new Pair(arr[right] + arr[rightNeighbor], right));
                set.add(new Pair(arr[left] + arr[right] + arr[rightNeighbor], left));
                prev[rightNeighbor] = left;
            }
            
            next[left] = rightNeighbor;
            arr[left] += arr[right];
            operations++;
        }
        return operations;
    }
}
